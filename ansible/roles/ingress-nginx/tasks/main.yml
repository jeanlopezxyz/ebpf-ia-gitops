---
- name: Add NGINX Ingress Helm repository
  kubernetes.core.helm_repository:
    name: ingress-nginx
    repo_url: https://kubernetes.github.io/ingress-nginx
    
- name: Install NGINX Ingress Controller
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    release_namespace: ingress-nginx
    create_namespace: true
    values:
      controller:
        # Enable metrics for monitoring
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true  # Now enabled since Prometheus is installed first
        # Enable admission webhooks
        admissionWebhooks:
          enabled: true
        # Service configuration - conditional based on environment
        service:
          type: "{{ ingress.nginx.service_type }}"
        # Enable SSL passthrough
        extraArgs:
          enable-ssl-passthrough: ""
        # Resource limits
        resources:
          requests:
            cpu: 100m
            memory: 90Mi
          limits:
            cpu: 500m
            memory: 512Mi
        # Node selector for scheduling
        nodeSelector:
          kubernetes.io/os: linux
        # Enable real IP preservation
        config:
          use-forwarded-headers: "true"
          compute-full-forwarded-for: "true"
          use-proxy-protocol: "false"
          proxy-real-ip-cidr: "0.0.0.0/0"
    wait: false
  # Continue if it takes too long
    
- name: Wait for NGINX Ingress pods to be running (simple validation)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: ingress-nginx
    label_selectors:
      - app.kubernetes.io/component=controller
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 180

- name: Get NGINX Ingress service information (optional)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: ingress-nginx-controller
    namespace: ingress-nginx
  register: nginx_service
  
- name: Create default backend for ingress
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: default-backend
        namespace: ingress-nginx
        labels:
          app: default-backend
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: default-backend
        template:
          metadata:
            labels:
              app: default-backend
          spec:
            containers:
            - name: default-backend
              image: gcr.io/google_containers/defaultbackend:1.0
              ports:
              - containerPort: 8080
              resources:
                requests:
                  cpu: 10m
                  memory: 20Mi
                limits:
                  cpu: 50m
                  memory: 50Mi
    state: present
    
- name: Create default backend service
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: default-backend
        namespace: ingress-nginx
        labels:
          app: default-backend
      spec:
        ports:
        - port: 80
          targetPort: 8080
        selector:
          app: default-backend
    state: present
    
- name: Test NGINX Ingress Controller
  uri:
    url: "http://{{ nginx_service.resources[0].status.loadBalancer.ingress[0].ip | default('localhost') }}/healthz"
    method: GET
    status_code: 200
  register: nginx_test
  until: nginx_test.status == 200
  retries: 5
  delay: 10
  ignore_errors: yes
  when: nginx_service.resources is defined and nginx_service.resources|length > 0 and nginx_service.resources[0].status.loadBalancer.ingress is defined
  
- name: Display NGINX Ingress information
  debug:
    msg:
      - "ğŸŒ NGINX Ingress Controller deployed successfully!"
      - "ğŸ“ LoadBalancer IP: {{ nginx_service.resources[0].status.loadBalancer.ingress[0].ip | default('Pending') if nginx_service.resources is defined and nginx_service.resources|length > 0 and nginx_service.resources[0].status.loadBalancer.ingress is defined else 'Pending' }}"
      - "ğŸ”— Internal Service: ingress-nginx-controller.ingress-nginx.svc.cluster.local"
      - "ğŸ“Š Metrics: Enabled with ServiceMonitor"
      - "ğŸ”§ SSL Passthrough: Enabled"
      - ""
      - "ğŸ› ï¸  Next Steps:"
      - "  1. Create Ingress resources for your applications"
      - "  2. Configure DNS entries pointing to LoadBalancer IP"
      - "  3. Add TLS certificates for HTTPS"
      - ""
      - "ğŸ“‹ Example Ingress:"
      - "  apiVersion: networking.k8s.io/v1"
      - "  kind: Ingress"
      - "  metadata:"
      - "    name: my-app-ingress"
      - "    annotations:"
      - "      kubernetes.io/ingress.class: nginx"
      - "  spec:"
      - "    rules:"
      - "    - host: my-app.local"
      - "      http:"
      - "        paths:"
      - "        - path: /"
      - "          pathType: Prefix"
      - "          backend:"
      - "            service:"
      - "              name: my-app"
      - "              port:"
      - "                number: 80"