---
- name: Add Cilium Helm repository
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
    
- name: Install Cilium CNI via Helm
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium.version }}"
    release_namespace: kube-system
    values:
      # eBPF configuration
      bpf:
        masquerade: true
        hostRouting: true
      # Hubble observability
      hubble:
        enabled: "{{ cilium.enable_hubble }}"
        relay:
          enabled: "{{ cilium.enable_hubble }}"
        ui:
          enabled: "{{ cilium.enable_hubble }}"
      # Gateway API support
      gatewayAPI:
        enabled: "{{ cilium.enable_gateway_api }}"
      # eBPF host firewall
      hostFirewall:
        enabled: true
      # Enable eBPF-based kube-proxy replacement
      kubeProxyReplacement: true
      # Enable bandwidth manager for eBPF
      bandwidthManager:
        enabled: true
      # Enable local redirect policy for eBPF
      localRedirectPolicy: true
    wait: true
    timeout: 300s
    
- name: Wait for Cilium DaemonSet to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    label_selectors:
      - k8s-app=cilium
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 600
    
# Cilium CLI installation removed - CNI works perfectly without CLI
  
- name: Display Cilium status
  debug:
    msg:
      - "ğŸ”Œ Cilium CNI with eBPF installed successfully!"
      - "ğŸ” Hubble observability: {{ 'Enabled' if cilium.enable_hubble else 'Disabled' }}"
      - "ğŸšª Gateway API: {{ 'Enabled' if cilium.enable_gateway_api else 'Disabled' }}"
      - "ğŸ›¡ï¸ eBPF Host Firewall: Enabled"
      - "âš¡ kube-proxy replacement: Strict eBPF mode"