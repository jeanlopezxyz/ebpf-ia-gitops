---
# Storage configuration for different cluster types

# Minikube storage
- name: Enable storage addon for Minikube
  command: minikube addons enable storage-provisioner --profile {{ minikube.profile }}
  ignore_errors: yes
  when: cluster_method == "minikube"

- name: Create StorageClass for Minikube
  kubernetes.core.k8s:
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: persistent-storage
        annotations:
          storageclass.kubernetes.io/is-default-class: "false"
      provisioner: k8s.io/minikube-hostpath
      volumeBindingMode: Immediate
      reclaimPolicy: Retain
      allowVolumeExpansion: true
      parameters:
        type: hostPath
    state: present
  when: cluster_method == "minikube"

# Kubeadm/KVM storage - using local-path-provisioner (Rancher)
- name: Install local-path-provisioner for kubeadm
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: local-path-storage
    state: present
  when: cluster_method == "kubeadm"

- name: Deploy local-path-provisioner
  kubernetes.core.k8s:
    state: present
    src: https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
  when: cluster_method == "kubeadm"

- name: Wait for local-path-provisioner to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: local-path-provisioner
    namespace: local-path-storage
    wait: true
    wait_condition:
      type: Progressing
      status: "True"
    wait_timeout: 120
  when: cluster_method == "kubeadm"

- name: Create default StorageClass for kubeadm
  kubernetes.core.k8s:
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: local-path
        annotations:
          storageclass.kubernetes.io/is-default-class: "true"
      provisioner: rancher.io/local-path
      volumeBindingMode: WaitForFirstConsumer
      reclaimPolicy: Delete
      allowVolumeExpansion: true
    state: present
  when: cluster_method == "kubeadm"

- name: Display storage setup results for Minikube
  debug:
    msg:
      - "‚úÖ Storage configuration completed!"
      - "üì¶ StorageClass: persistent-storage (hostPath, retain policy)"
      - "üîß Provisioner: k8s.io/minikube-hostpath"
  when: cluster_method == "minikube"

- name: Display storage setup results for kubeadm
  debug:
    msg:
      - "‚úÖ Storage configuration completed!"
      - "üì¶ StorageClass: local-path (default)"
      - "üîß Provisioner: rancher.io/local-path"
      - "üìÅ Storage path: /opt/local-path-provisioner"
  when: cluster_method == "kubeadm"