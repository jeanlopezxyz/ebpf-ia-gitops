---
- name: Get Minikube driver type
  command: minikube config get driver --profile {{ minikube.profile }}
  register: minikube_driver_cmd
  ignore_errors: yes
  
- name: Set driver fact
  set_fact:
    minikube_driver: "{{ minikube_driver_cmd.stdout | default('podman') }}"
    
- name: Display storage configuration info
  debug:
    msg:
      - "ğŸ—„ï¸  Configuring storage for Minikube driver: {{ minikube_driver }}"
      - "ğŸ“Š Available storage options:"
      - "  - standard: Default Minikube storage (hostPath)"
      - "  - standard-rwo: ReadWriteOnce volumes"
      - "  - local-storage: Local persistent volumes"

- name: Enable storage addon for Minikube
  command: minikube addons enable storage-provisioner --profile {{ minikube.profile }}
  ignore_errors: yes

- name: Enable volumesnapshots addon (if available)
  command: minikube addons enable volumesnapshots --profile {{ minikube.profile }}
  ignore_errors: yes

- name: Create enhanced StorageClass for persistent data
  kubernetes.core.k8s:
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: persistent-storage
        annotations:
          storageclass.kubernetes.io/is-default-class: "false"
      provisioner: k8s.io/minikube-hostpath
      volumeBindingMode: Immediate
      reclaimPolicy: Retain  # Keep data even if PVC is deleted
      allowVolumeExpansion: true
      parameters:
        type: hostPath
    state: present


- name: Display storage setup results
  debug:
    msg:
      - "âœ… Storage configuration completed!"
      - "ğŸ”§ Minikube Driver: {{ minikube_driver }}"
      - "ğŸ“¦ StorageClasses created:"
      - "  - persistent-storage (hostPath, retain policy)"
      - ""
      - "ğŸ’¡ Storage Features:"
      - "  - Retain policy: Data survives PVC deletion"
      - "  - Volume expansion: Can grow storage if needed"
      - "{% if minikube_driver == 'docker' %}  - Local storage: Better performance for Docker driver{% endif %}"
      - ""
      - "ğŸ—‚ï¸  Storage Locations:"
      - "  - hostPath: /tmp/hostpath-provisioner/"
