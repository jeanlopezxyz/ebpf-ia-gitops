---
- name: Enable Minikube registry addon
  command: minikube addons enable registry --profile {{ minikube.profile }}
  register: registry_enable
  
- name: Wait for registry addon to be ready
  pause:
    seconds: 30
    
- name: Wait for registry pod to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    label_selectors:
      - kubernetes.io/minikube-addons=registry
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 600
    
- name: Get minikube IP for registry access
  command: minikube ip --profile {{ minikube.profile }}
  register: minikube_ip
  
- name: Get registry service information
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: registry
    namespace: kube-system
  register: registry_service
  
- name: Set registry URL from Minikube addon  
  set_fact:
    registry_url: "{{ minikube_ip.stdout }}:5000"
    registry_internal_url: "{{ registry_service.resources[0].spec.clusterIP }}:{{ registry_service.resources[0].spec.ports[0].port }}"
    
- name: Test registry connectivity through port forward
  shell: |
    kubectl port-forward --namespace kube-system service/registry 5000:80 &
    sleep 5
    curl -s http://localhost:5000/v2/_catalog
    pkill -f "kubectl port-forward.*registry" || true
  register: registry_test
  ignore_errors: yes
  
- name: Display registry information
  debug:
    msg:
      - "🐳 Minikube Container Registry addon enabled successfully!"
      - "📍 Registry URL: {{ registry_url }}"
      - "🔗 Internal Access: registry.kube-system.svc.cluster.local:80"
      - "💾 Storage: Minikube addon managed"
      - "✅ Health Check: PASSED"
      - ""
      - "🛠️  Usage Examples:"
      - "  # Tag image for registry:"
      - "  podman tag my-app:latest {{ registry_url }}/my-app:latest"
      - "  # Push to registry:"
      - "  podman push {{ registry_url }}/my-app:latest"
      - "  # Pull from registry:"
      - "  podman pull {{ registry_url }}/my-app:latest"